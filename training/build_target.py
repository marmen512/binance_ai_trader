"""
Модуль побудови цільової змінної для навчання моделі.

Створює мульти-класову цільову змінну на основі майбутньої прибутковості.
"""

import pandas as pd


def build_target(df, horizon=5, threshold=0.004):
    """
    Створює мульти-класову цільову змінну (-1, 0, 1) на основі майбутньої прибутковості.
    
    Логіка класифікації:
    - 1 (BUY): якщо майбутня прибутковість > threshold (сильне зростання)
    - -1 (SELL): якщо майбутня прибутковість < -threshold (сильне падіння)
    - 0 (HOLD): інакше (бічний рух)
    
    Параметри:
        df (pd.DataFrame): DataFrame з колонкою 'close'
        horizon (int): горизонт прогнозування (кількість періодів вперед).
                      За замовчуванням 5 - означає прогноз на 5 свічок вперед.
        threshold (float): поріг для класифікації руху ціни.
                          За замовчуванням 0.004 (0.4%) - мінімальний рух для сигналу.
                          
    Повертає:
        pd.DataFrame: Оригінальний DataFrame з додатковою колонкою 'target'
    """
    df = df.copy()
    
    # Обчислюємо майбутню прибутковість через horizon періодів
    future_ret = df['close'].pct_change(horizon).shift(-horizon)
    
    # Класифікуємо на основі порогу
    df['target'] = 0  # За замовчуванням HOLD
    df.loc[future_ret > threshold, 'target'] = 1  # BUY при зростанні
    df.loc[future_ret < -threshold, 'target'] = -1  # SELL при падінні
    
    # Видаляємо останні horizon рядків (немає майбутніх даних)
    df = df.iloc[:-horizon]
    
    return df
